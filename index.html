<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Habit Tracker</title>
<style>
:root{
  --bg:#ffffff; --fg:#111; --muted:#6b7280; --grid:#e5e7eb; --card:#f9fafb; --accent:#2563eb;
  --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --today:#dbeafe; --shadow:0 2px 6px rgba(0,0,0,.08)
}
[data-mode="dark"]{
  --bg:#0e1117; --fg:#e8eefc; --muted:#9aa5c2; --grid:#1f2937; --card:#151e33; --accent:#3b82f6;
  --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --today:#1e3a8a; --shadow:0 4px 10px rgba(0,0,0,.45)
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--fg);display:flex;flex-direction:column}
header,footer{background:var(--card);box-shadow:var(--shadow);position:sticky;z-index:20}
header{top:0;padding:.6rem .8rem;display:grid;grid-template-columns:1fr auto;gap:.6rem;align-items:center}
header .left{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center}
header .right{display:flex;flex-wrap:wrap;gap:.5rem;justify-content:flex-end}
h1{font-size:1.05rem;margin:0}
select,button{appearance:none;background:var(--card);color:var(--fg);border:1px solid var(--grid);padding:.35rem .55rem;border-radius:8px;cursor:pointer}
button:hover{background:var(--accent);color:#fff;border-color:transparent}
button[aria-pressed="true"]{outline:2px solid var(--accent)}
.badge{display:inline-block;min-width:2.1ch;padding:.05rem .45rem;border-radius:999px;background:var(--accent);color:#fff;font-size:.78rem;line-height:1.3}
.card{background:var(--card);border:1px solid var(--grid);border-radius:12px;padding:.9rem;box-shadow:var(--shadow)}
.grid{display:grid;gap:.8rem}
main{flex:1;min-height:0;overflow:auto;padding:1rem}
table{width:100%;border-collapse:collapse;background:var(--card);border:1px solid var(--grid);border-radius:12px;overflow:hidden}
thead th,tbody td,tbody th{border:1px solid var(--grid);padding:.35rem;text-align:center;vertical-align:middle}
thead th{position:sticky;top:0;background:var(--card);z-index:1}
tbody tr.today{background:var(--today)}
tbody input[type="checkbox"]{width:1.15rem;height:1.15rem}
.totals{display:grid;grid-template-columns:1fr;gap:.8rem;margin-bottom:.8rem}
.progress{height:.65rem;background:var(--grid);border-radius:999px;overflow:hidden}
.progress > span{display:block;height:100%;background:var(--accent)}
.tip{font-size:.86rem;color:var(--muted)}
/* Modal base */
#modal,#habitModal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:40}
.modal-content{background:var(--bg);color:var(--fg);max-width:min(1100px,94vw);max-height:90vh;overflow:auto;border-radius:14px;border:1px solid var(--grid);box-shadow:var(--shadow);padding:1rem}
.modal-head{display:flex;gap:.6rem;align-items:center;justify-content:space-between;margin-bottom:.5rem}
.modal-actions{display:flex;flex-wrap:wrap;gap:.5rem}
.modal-grid{display:grid;gap:1rem}
@media (min-width:860px){.modal-grid{grid-template-columns:1fr 1fr}}
.canvas-wrap{background:var(--card);border:1px solid var(--grid);border-radius:12px;padding:.6rem}
.canvas-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:.4rem}
.canvas-head h4{margin:.2rem 0;font-size:.95rem}
canvas{display:block;width:100%;height:auto}
.tooltip{position:fixed;pointer-events:none;background:var(--card);color:var(--fg);border:1px solid var(--grid);border-radius:8px;padding:.45rem .6rem;font-size:.85rem;box-shadow:var(--shadow);display:none;z-index:50;max-width:260px;white-space:nowrap}
footer{bottom:0;padding:.6rem 1rem;text-align:center;font-size:.85rem}
.kpi{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center}
.kpi .pill{background:var(--grid);color:var(--fg);padding:.25rem .55rem;border-radius:999px;font-size:.8rem}
.header-badges{display:flex;gap:.4rem;flex-wrap:wrap}
.small{font-size:.82rem;color:var(--muted)}
.hidden{display:none}
</style>
</head>
<body>
<header>
  <div class="left">
    <h1>Habit Tracker</h1>
    <select id="month" aria-label="Seleccionar mes"></select>
    <select id="year" aria-label="Seleccionar año"></select>
    <button id="toggleView" aria-pressed="false" title="Cambiar entre vista mensual y anual">Mes</button>
    <button id="todayBtn" title="Ir a hoy">Hoy</button>
    <button id="habitBtn" title="Editar hábitos">Hábitos</button>
    <button id="heatBtn" title="Abrir mapa de calor">Mapa de calor</button>
  </div>
  <div class="right">
    <button id="backupBtn" title="Exportar respaldo JSON">Backup</button>
    <button id="importBtn" title="Importar respaldo JSON">Importar</button>
    <button id="csvBtn" title="Exportar CSV mensual">CSV</button>
    <select id="smooth" aria-label="Suavizado de tendencia">
      <option value="3">3</option>
      <option value="7" selected>7</option>
      <option value="14">14</option>
    </select>
    <button id="modeBtn" title="Cambiar claro/oscuro">Claro</button>
  </div>
</header>

<main id="main">
  <div class="totals" id="totals"></div>
  <div class="card" id="trendCard" aria-label="Tendencia diaria">
    <div class="kpi">
      <strong>Tendencia diaria</strong>
      <span class="pill">Media móvil: <span id="smoothLabel">7</span></span>
    </div>
    <div id="trendWrap" style="margin-top:.6rem"></div>
    <div class="small">Porcentaje de hábitos cumplidos por día (sin ajuste de meta).</div>
  </div>
  <div id="tableWrap" style="margin-top:1rem"></div>
</main>

<footer>Hecho para Pato · Offline · Exporta respaldo con “Backup”.</footer>

<!-- Modal Mapas -->
<div id="modal" role="dialog" aria-modal="true">
  <div class="modal-content">
    <div class="modal-head">
      <strong>Mapa de calor del mes</strong>
      <div class="modal-actions">
        <button id="dlCal">Descargar calendario PNG</button>
        <button id="dlDonut">Descargar donut PNG</button>
        <button id="dlBars">Descargar barras PNG</button>
        <button id="closeModal">Cerrar</button>
      </div>
    </div>
    <div class="modal-grid">
      <div class="canvas-wrap">
        <div class="canvas-head"><h4>Calendario (Lun–Dom)</h4></div>
        <canvas id="calCanvas" width="900" height="600" aria-label="Calendario heatmap"></canvas>
      </div>
      <div class="canvas-wrap">
        <div class="canvas-head"><h4>Donut mensual</h4></div>
        <canvas id="donutCanvas" width="900" height="600" aria-label="Donut mensual"></canvas>
      </div>
      <div class="canvas-wrap" style="grid-column:1/-1">
        <div class="canvas-head"><h4>Barras por hábito (20 niveles)</h4></div>
        <canvas id="barsCanvas" width="1400" height="420" aria-label="Barras por hábito"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Modal Hábitos -->
<div id="habitModal" role="dialog" aria-modal="true">
  <div class="modal-content">
    <div class="modal-head">
      <strong>Hábitos (máx. 12)</strong>
      <div class="modal-actions">
        <button id="addHabit">Añadir</button>
        <button id="saveHabit">Guardar</button>
        <button id="closeHabit">Cerrar</button>
      </div>
    </div>
    <div id="habitBody" class="grid"></div>
  </div>
</div>

<!-- Tooltip (para barras/calendario) -->
<div class="tooltip" id="tooltip"></div>

<script>
(()=>{
// ---------- Utilidades ----------
const QS=(s,d=document)=>d.querySelector(s), QSA=(s,d=document)=>[...d.querySelectorAll(s)];
const LS=localStorage;
const NOW=new Date();
const MONTHS_ES=[..."Ene Feb Mar Abr May Jun Jul Ago Sep Oct Nov Dic".split(" ")];
const WD_ES=["Dom","Lun","Mar","Mié","Jue","Vie","Sáb"];
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const pad=n=>String(n).padStart(2,'0');
const ymd=(y,m,d)=>`${y}-${pad(m+1)}-${pad(d)}`;
const hex2rgb=h=>{h=h.replace('#','');if(h.length===3)h=[h[0]+h[0],h[1]+h[1],h[2]+h[2]].join('');const n=parseInt(h,16);return [(n>>16)&255,(n>>8)&255,n&255]};
const rgb2hex=(r,g,b)=>"#"+[r,g,b].map(x=>pad(x.toString(16))).join('');
const mix=(c1,c2,t)=>{const a=hex2rgb(c1),b=hex2rgb(c2);return rgb2hex(...a.map((v,i)=>Math.round(v+(b[i]-v)*t)))};
const easeOutCubic=t=>1-Math.pow(1-t,3);
const HEAT_RED="#ef4444",HEAT_YEL="#f59e0b",HEAT_GRN="#22c55e";
const heatColor=p=>{
  const x=clamp(p,0,100);
  if(x<=50)return mix(HEAT_RED,HEAT_YEL,x/50);
  return mix(HEAT_YEL,HEAT_GRN,(x-50)/50);
};
const getAccent=()=>getComputedStyle(document.documentElement).getPropertyValue('--accent').trim()||'#2563eb';

// ---------- Estado ----------
let mode=LS.getItem('habit-mode')||'light';
let view=LS.getItem('habit-view')||'month';
let smooth=+LS.getItem('trend-smooth')||7;
let habits=JSON.parse(LS.getItem('habit-list-weekly')||'[]'); // [{name,freq}]
const monthSel=QS('#month'),yearSel=QS('#year');

document.body.dataset.mode=mode;
QS('#modeBtn').textContent = mode==='light'?'Oscuro':'Claro';
QS('#smooth').value=String(smooth);
QS('#smoothLabel').textContent=String(smooth);

(function fillSelectors(){
  // Meses (mostrar nombres en español, valor 0..11)
  for(let m=0;m<12;m++){
    const op=document.createElement('option');
    op.value=String(m);
    op.textContent=new Date(2024,m,1).toLocaleString('es',{month:'long'});
    monthSel.append(op);
  }
  // Años (rango centrado alrededor del año actual)
  for(let y=NOW.getFullYear()-3;y<=NOW.getFullYear()+1;y++){
    const op=document.createElement('option');op.value=String(y);op.textContent=String(y);yearSel.append(op);
  }
  monthSel.value=String(NOW.getMonth());
  yearSel.value=String(NOW.getFullYear());
})();

// ---------- Almacenamiento por mes ----------
const keyMonth=(y,m)=>`habit-weekly-v3:${y}-${pad(m+1)}`;
const getMonthData=(y,m)=>JSON.parse(LS.getItem(keyMonth(y,m))||'{}');
const setMonthData=(y,m,obj)=>LS.setItem(keyMonth(y,m),JSON.stringify(obj));

// ---------- Semanas "naturales" dentro del mes (bloques 1-7, 8-14, etc.) ----------
const monthBlocks=(y,m)=>{
  const days=new Date(y,m+1,0).getDate();
  const blocks=[];
  for(let start=1;start<=days;start+=7){
    const end=Math.min(start+6,days);
    const arr=[];for(let d=start;d<=end;d++)arr.push(d);
    blocks.push(arr);
  }
  return blocks;
};

// ---------- Cálculos por hábito (goal, weighted, raw, pct) ----------
function habitStats(y,m,idx){
  const h=habits[idx]; if(!h){return {goal:0,weighted:0,raw:0,pct:0};}
  const data=getMonthData(y,m);
  const blocks=monthBlocks(y,m);
  let goal=0,weighted=0,raw=0;
  for(const week of blocks){
    const g=Math.min(h.freq, week.length);
    goal+=g;
    let cnt=0;
    for(const d of week){
      const k=`${ymd(y,m,d)}:${idx}`;
      if(data[k]) cnt++;
    }
    raw+=cnt;
    weighted+=Math.min(cnt,g);
  }
  const pct = goal>0 ? Math.min(100, Math.round(100*weighted/goal)) : (raw>0?100:0);
  return {goal,weighted,raw,pct};
}

// ---------- Cálculo total del mes ----------
function totalsStats(y,m){
  let goal=0,weighted=0,raw=0;
  for(let i=0;i<habits.length;i++){
    const s=habitStats(y,m,i);
    goal+=s.goal; weighted+=s.weighted; raw+=s.raw;
  }
  const pct = goal>0 ? Math.min(100, Math.round(100*weighted/goal)) : 0;
  return {goal,weighted,raw,pct};
}

// ---------- % diario (sin ajuste) ----------
function dailyPercents(y,m){
  const nHab=habits.length;
  const days=new Date(y,m+1,0).getDate();
  if(nHab===0){ return new Array(days).fill(0); }
  const data=getMonthData(y,m);
  const arr=[];
  for(let d=1;d<=days;d++){
    let c=0;
    for(let i=0;i<nHab;i++){
      if(data[`${ymd(y,m,d)}:${i}`]) c++;
    }
    arr.push( Math.round(100*c/nHab) );
  }
  return arr;
}

// ---------- Media móvil centrada ----------
function movingAvg(arr,k){
  if(k<=1)return arr.slice();
  const out=[];
  const r=Math.floor(k/2);
  for(let i=0;i<arr.length;i++){
    let s=0,c=0;
    for(let j=i-r;j<=i+r;j++){
      if(j>=0&&j<arr.length){s+=arr[j];c++;}
    }
    out.push(Math.round(s/c));
  }
  return out;
}

// ---------- Tendencia SVG (Catmull–Rom → Bezier) ----------
function pathFromPoints(pts){
  if(pts.length<2) return '';
  const d=[];
  d.push(`M ${pts[0][0]} ${pts[0][1]}`);
  for(let i=0;i<pts.length-1;i++){
    const p0=pts[i-1]||pts[i];
    const p1=pts[i];
    const p2=pts[i+1];
    const p3=pts[i+2]||p2;
    const cp1x=p1[0]+(p2[0]-p0[0])/6;
    const cp1y=p1[1]+(p2[1]-p0[1])/6;
    const cp2x=p2[0]-(p3[0]-p1[0])/6;
    const cp2y=p2[1]-(p3[1]-p1[1])/6;
    d.push(`C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${p2[0]} ${p2[1]}`);
  }
  return d.join(' ');
}

function renderTrend(y,m){
  const wrap=QS('#trendWrap'); wrap.innerHTML='';
  const w=wrap.clientWidth||600, h=160, padL=24, padR=10, padT=12, padB=22;
  const data=dailyPercents(y,m);
  const smoothArr=movingAvg(data, smooth);
  const maxY=100, minY=0;
  const mapX=i=>padL + (i*(w-padL-padR))/(Math.max(1,data.length-1));
  const mapY=v=>padT + (maxY-v)*(h-padT-padB)/(maxY-minY);

  const pts=smoothArr.map((v,i)=>[mapX(i), mapY(v)]);
  const path=pathFromPoints(pts);
  const accent=getAccent();

  // SVG
  const svgNS='http://www.w3.org/2000/svg';
  const svg=document.createElementNS(svgNS,'svg');
  svg.setAttribute('width','100%'); svg.setAttribute('height',h); svg.setAttribute('viewBox',`0 0 ${w} ${h}`);

  // grid (25%)
  const grid=document.createElementNS(svgNS,'g');
  [0,25,50,75,100].forEach(val=>{
    const y=mapY(val);
    const line=document.createElementNS(svgNS,'line');
    line.setAttribute('x1',String(padL)); line.setAttribute('x2',String(w-padR));
    line.setAttribute('y1',String(y)); line.setAttribute('y2',String(y));
    line.setAttribute('stroke','var(--grid)'); line.setAttribute('stroke-width','1');
    grid.appendChild(line);

    const txt=document.createElementNS(svgNS,'text');
    txt.setAttribute('x',String(4)); txt.setAttribute('y',String(y+4));
    txt.setAttribute('fill','var(--muted)'); txt.setAttribute('font-size','10');
    txt.textContent=`${val}%`;
    grid.appendChild(txt);
  });
  svg.appendChild(grid);

  // gradient
  const defs=document.createElementNS(svgNS,'defs');
  const grad=document.createElementNS(svgNS,'linearGradient');
  grad.setAttribute('id','trendGrad');
  grad.setAttribute('x1','0'); grad.setAttribute('y1','0');
  grad.setAttribute('x2','0'); grad.setAttribute('y2','1');
  const s1=document.createElementNS(svgNS,'stop'); s1.setAttribute('offset','0%'); s1.setAttribute('stop-color',accent); s1.setAttribute('stop-opacity','0.35');
  const s2=document.createElementNS(svgNS,'stop'); s2.setAttribute('offset','100%'); s2.setAttribute('stop-color',accent); s2.setAttribute('stop-opacity','0.02');
  grad.appendChild(s1); grad.appendChild(s2); defs.appendChild(grad); svg.appendChild(defs);

  // area
  if(pts.length>=2){
    const area=document.createElementNS(svgNS,'path');
    const baseY=mapY(0);
    area.setAttribute('d', `${path} L ${pts[pts.length-1][0]} ${baseY} L ${pts[0][0]} ${baseY} Z`);
    area.setAttribute('fill','url(#trendGrad)');
    svg.appendChild(area);
  }
  // line
  const line=document.createElementNS(svgNS,'path');
  line.setAttribute('d', path);
  line.setAttribute('fill','none');
  line.setAttribute('stroke',accent);
  line.setAttribute('stroke-width','2.2');
  svg.appendChild(line);

  wrap.appendChild(svg);
}

// ---------- UI: Totales y Tip ----------
function renderTotals(y,m){
  const t=totalsStats(y,m);
  const host=QS('#totals'); host.innerHTML='';
  const card=document.createElement('div'); card.className='card';
  const top=document.createElement('div'); top.style.display='flex'; top.style.justifyContent='space-between'; top.style.alignItems='center';
  const title=document.createElement('strong'); title.textContent='Progreso total (ajustado a metas semanales)';
  const badge=document.createElement('span'); badge.className='badge'; badge.textContent=`${t.pct}%`;
  top.appendChild(title); top.appendChild(badge);

  const bar=document.createElement('div'); bar.className='progress'; bar.style.margin='.6rem 0';
  const fill=document.createElement('span'); fill.style.width=`${t.pct}%`; bar.appendChild(fill);

  const sub=document.createElement('div'); sub.className='small'; sub.textContent=`${t.weighted}/${t.goal} (weighted/goal) · Crudo: ${t.raw}`;
  const tip=document.createElement('div'); tip.className='tip'; tip.textContent='TIP: El “cap” semanal limita los checks por semana al máximo definido por la meta semanal del hábito. El porcentaje se calcula con Weighted/Goal y se limita a 100%.';
  card.append(top,bar,sub,tip);
  host.appendChild(card);
}

// ---------- Tabla mensual ----------
function renderMonth(y,m){
  const tableWrap=QS('#tableWrap'); tableWrap.innerHTML='';
  const nHab=habits.length;
  const days=new Date(y,m+1,0).getDate();
  const data=getMonthData(y,m);

  // tabla
  const tbl=document.createElement('table');
  const thead=document.createElement('thead');
  const htr=document.createElement('tr');
  const thDay=document.createElement('th'); thDay.textContent='Día'; htr.appendChild(thDay);

  habits.forEach((h,i)=>{
    const th=document.createElement('th');
    const b=habitStats(y,m,i);
    th.innerHTML=`<div style="display:flex;gap:.35rem;align-items:center;justify-content:center"><span>${h.name}</span><span class="badge">${b.pct}%</span></div>`;
    htr.appendChild(th);
  });
  thead.appendChild(htr); tbl.appendChild(thead);

  const tbody=document.createElement('tbody');
  for(let d=1;d<=days;d++){
    const tr=document.createElement('tr');
    if(y===NOW.getFullYear() && m===NOW.getMonth() && d===NOW.getDate()) tr.classList.add('today');
    const dayCell=document.createElement('th'); dayCell.textContent=`${d} (${WD_ES[new Date(y,m,d).getDay()]})`; dayCell.style.whiteSpace='nowrap';
    tr.appendChild(dayCell);
    for(let i=0;i<nHab;i++){
      const td=document.createElement('td');
      const chk=document.createElement('input'); chk.type='checkbox';
      const k=`${ymd(y,m,d)}:${i}`;
      chk.checked=!!data[k];
      chk.addEventListener('change', (ev)=>{
        data[k]=chk.checked; setMonthData(y,m,data);
        miniConfetti(ev.clientX, ev.clientY);
        refreshAll(); // badges, totales, tendencia
      });
      td.appendChild(chk);
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
  tbl.appendChild(tbody);
  tableWrap.appendChild(tbl);
}

// ---------- Vista anual ----------
function renderYear(y){
  const tableWrap=QS('#tableWrap'); tableWrap.innerHTML='';
  const grid=document.createElement('div'); grid.className='grid'; grid.style.gridTemplateColumns='repeat(auto-fill,minmax(220px,1fr))';
  for(let m=0;m<12;m++){
    const t=totalsStats(y,m);
    const card=document.createElement('div'); card.className='card'; card.style.cursor='pointer';
    const head=document.createElement('div'); head.style.display='flex'; head.style.justifyContent='space-between'; head.style.alignItems='center';
    const title=document.createElement('strong'); title.textContent=new Date(y,m,1).toLocaleString('es',{month:'long'});
    const badge=document.createElement('span'); badge.className='badge'; badge.textContent=`${t.pct}%`;
    head.append(title,badge);
    const bar=document.createElement('div'); bar.className='progress'; bar.style.margin='.6rem 0';
    const fill=document.createElement('span'); fill.style.width=`${t.pct}%`; bar.appendChild(fill);
    const sub=document.createElement('div'); sub.className='small'; sub.textContent=`${t.weighted}/${t.goal} (weighted/goal)`;
    card.append(head,bar,sub);
    card.addEventListener('click',()=>{
      monthSel.value=String(m); view='month'; LS.setItem('habit-view',view); refreshAll();
      setTimeout(scrollToToday, 60);
    });
    grid.appendChild(card);
  }
  tableWrap.appendChild(grid);
}

// ---------- Render principal ----------
function refreshAll(){
  const y=+yearSel.value, m=+monthSel.value;
  renderTotals(y,m);
  if(view==='month') renderMonth(y,m); else renderYear(y);
  renderTrend(y,m);
}

// ---------- Scroll a hoy ----------
function scrollToToday(){
  const row=QS('tbody tr.today');
  if(row) row.scrollIntoView({behavior:'smooth', block:'center'});
}

// ---------- Confeti mini ----------
function miniConfetti(x,y){
  const colors=[getAccent(),'#10b981','#f59e0b','#ef4444'];
  for(let i=0;i<10;i++){
    const s=document.createElement('span');
    s.style.position='fixed'; s.style.left=`${x}px`; s.style.top=`${y}px`;
    s.style.width='6px'; s.style.height='6px'; s.style.borderRadius='50%';
    s.style.background=colors[i%colors.length]; s.style.pointerEvents='none'; s.style.zIndex='60';
    document.body.appendChild(s);
    const dx=(Math.random()*2-1)*80, dy=(Math.random()*-1)*100-40, rot=(Math.random()*360);
    const dur=600+Math.random()*500;
    s.animate([{transform:`translate(0,0) rotate(0deg)`,opacity:1},{transform:`translate(${dx}px,${dy}px) rotate(${rot}deg)`,opacity:0}],{duration:dur,easing:'cubic-bezier(.05,.6,.2,1)'});
    setTimeout(()=>s.remove(), dur+30);
  }
}

// ---------- Modal Hábitos ----------
function openHabitModal(){
  const modal=QS('#habitModal'); const body=QS('#habitBody'); body.innerHTML='';
  const list=document.createElement('div'); list.className='grid';
  habits.forEach((h,i)=>{
    const row=document.createElement('div'); row.className='card'; row.style.display='grid'; row.style.gridTemplateColumns='1fr 90px 34px'; row.style.gap='.6rem'; row.style.alignItems='center';
    const name=document.createElement('input'); name.value=h.name; name.placeholder='Nombre (puede incluir emoji)';
    const freq=document.createElement('input'); freq.type='number'; freq.min='0'; freq.max='7'; freq.value=String(h.freq); freq.style.textAlign='center';
    const del=document.createElement('button'); del.textContent='×'; del.title='Eliminar';
    del.addEventListener('click',()=>{habits.splice(i,1); openHabitModal();});
    row.append(name,freq,del);
    list.appendChild(row);
  });
  body.appendChild(list);
  modal.style.display='flex';

  QS('#addHabit').onclick=()=>{
    if(habits.length>=12) return;
    habits.push({name:'Nuevo hábito', freq:3});
    openHabitModal();
  };
  QS('#saveHabit').onclick=()=>{
    const rows=[...body.querySelectorAll('.card')];
    habits=rows.map(r=>{
      const [nm,fr]=[r.children[0].value, clamp(+r.children[1].value,0,7)];
      return {name:nm.trim()||'Hábito', freq:fr};
    });
    LS.setItem('habit-list-weekly', JSON.stringify(habits));
    closeHabitModal();
    refreshAll();
  };
  QS('#closeHabit').onclick=closeHabitModal;
  modal.addEventListener('click', e=>{ if(e.target===modal) closeHabitModal(); });
}
function closeHabitModal(){ QS('#habitModal').style.display='none'; }

// ---------- Modal Heatmap (calendario + donut + barras) ----------
let barsHit=[]; // bboxes para tooltip
function openHeatmap(){
  const modal=QS('#modal'); modal.style.display='flex';
  QS('#closeModal').onclick=()=>modal.style.display='none';
  modal.addEventListener('click', e=>{ if(e.target===modal) modal.style.display='none'; });
  const y=+yearSel.value, m=+monthSel.value;
  drawCalendar(y,m);
  drawDonut(y,m);
  drawBars(y,m);
}
function drawCalendar(y,m){
  const cnv=QS('#calCanvas'), ctx=cnv.getContext('2d');
  const W=cnv.width, H=cnv.height;
  ctx.clearRect(0,0,W,H);
  const accent=getAccent();
  const dpc=dailyPercents(y,m);
  const firstDow=(new Date(y,m,1).getDay()+6)%7; // 0=Mon .. 6=Sun
  const days=new Date(y,m+1,0).getDate();
  const cols=7, rows=Math.ceil((firstDow+days)/7);
  const pad=40, cellW=(W-pad-10)/cols, cellH=(H-pad-10)/Math.max(rows,5);

  // títulos
  ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--fg');
  ctx.font='16px system-ui';
  ctx.fillText(new Date(y,m,1).toLocaleString('es',{month:'long',year:'numeric'}), 10, 24);
  ctx.font='12px system-ui';
  const wd=['Lun','Mar','Mié','Jue','Vie','Sáb','Dom'];
  wd.forEach((w,i)=>{ ctx.fillText(w, pad + i*cellW + 6, 40); });

  // celdas
  let day=1;
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const idx=r*cols+c;
      const x=pad + c*cellW, y0=50 + r*cellH;
      let valid = (r>0 || c>=firstDow) && day<=days;
      ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--grid');
      ctx.lineWidth=1;
      ctx.strokeRect(x, y0, cellW-6, cellH-6);
      if(valid){
        const p=dpc[day-1]||0;
        const col=heatColor(p);
        ctx.fillStyle=col; ctx.globalAlpha=0.85; ctx.fillRect(x, y0, cellW-6, cellH-6); ctx.globalAlpha=1;
        ctx.fillStyle='#000000';
        const fg=getComputedStyle(document.documentElement).getPropertyValue('--fg').trim();
        ctx.fillStyle=fg||'#111';
        ctx.font='11px system-ui';
        ctx.fillText(String(day), x+6, y0+14);
        day++;
      }
    }
  }
  // descarga
  QS('#dlCal').onclick=()=>downloadCanvas(cnv,`cal-${y}-${pad(m+1)}.png`);
}

function drawDonut(y,m){
  const cnv=QS('#donutCanvas'), ctx=cnv.getContext('2d');
  const W=cnv.width, H=cnv.height;
  ctx.clearRect(0,0,W,H);
  const cx=W/2, cy=H/2, r=Math.min(W,H)*0.28, rIn=r*0.6;
  // conteos por hábito
  const days=new Date(y,m+1,0).getDate(), data=getMonthData(y,m);
  const counts=habits.map((_,i)=>{
    let c=0; for(let d=1;d<=days;d++) if(data[`${ymd(y,m,d)}:${i}`]) c++;
    return c;
  });
  const total=counts.reduce((a,b)=>a+b,0);

  // título
  ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--fg');
  ctx.font='16px system-ui'; ctx.textAlign='left'; ctx.textBaseline='alphabetic';
  ctx.fillText('Donut de participación mensual', 10, 24);

  if(total===0){
    ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.font='14px system-ui';
    ctx.fillText('Sin datos este mes', cx, cy);
    QS('#dlDonut').onclick=()=>downloadCanvas(cnv,`donut-${y}-${pad(m+1)}.png`);
    return;
  }

  // arcos
  let start=-Math.PI/2;
  for(let i=0;i<habits.length;i++){
    if(counts[i]===0) continue;
    const frac=counts[i]/total;
    const end=start+frac*2*Math.PI;
    const p=easeOutCubic(Math.min(1, counts[i]/(days))); // sesgo suave opcional
    const col=heatColor( clamp(100*p,0,100) );
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,start,end); ctx.closePath();
    ctx.fillStyle=col; ctx.globalAlpha=0.9; ctx.fill(); ctx.globalAlpha=1;
    start=end;
  }
  // agujero
  ctx.globalCompositeOperation='destination-out';
  ctx.beginPath(); ctx.arc(cx,cy,rIn,0,Math.PI*2); ctx.fill();
  ctx.globalCompositeOperation='source-over';

  // etiqueta centro
  ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--fg');
  ctx.font='bold 22px system-ui'; ctx.fillText(`${total}`, cx, cy-4);
  ctx.font='12px system-ui'; ctx.fillText('checks', cx, cy+14);

  QS('#dlDonut').onclick=()=>downloadCanvas(cnv,`donut-${y}-${pad(m+1)}.png`);
}

function drawBars(y,m){
  const cnv=QS('#barsCanvas'), ctx=cnv.getContext('2d');
  const W=cnv.width, H=cnv.height;
  ctx.clearRect(0,0,W,H);
  barsHit.length=0;

  // marco
  const padL=54, padR=14, padT=18, padB=36;
  // ejes y grilla
  ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--grid'); ctx.lineWidth=1;
  [0,25,50,75,100].forEach(v=>{
    const yv=padT + (100-v)*(H-padT-padB)/100;
    ctx.beginPath(); ctx.moveTo(padL,yv); ctx.lineTo(W-padR,yv); ctx.stroke();
    ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--muted'); ctx.font='10px system-ui';
    ctx.fillText(`${v}%`, 6, yv+3);
  });
  // meta 100% (discontinua)
  ctx.setLineDash([6,4]); ctx.strokeStyle=getAccent(); ctx.lineWidth=1.2;
  const y100=padT + 0*(H-padT-padB); ctx.beginPath(); ctx.moveTo(padL,y100); ctx.lineTo(W-padR,y100); ctx.stroke();
  ctx.setLineDash([]);

  // columnas
  const n=Math.max(1,habits.length);
  const colW=(W-padL-padR)/n;
  const baseY=padT + (H-padT-padB);

  for(let i=0;i<habits.length;i++){
    const s=habitStats(y,m,i);
    const pct=s.pct;
    const biased=easeOutCubic(pct/100)*100;
    const col=heatColor(biased);
    const x=padL + i*colW;
    const innerPad=10;
    const bw=colW-innerPad;
    const levels=20;
    const bh=(H-padT-padB)/levels;
    const filled=Math.round((pct/100)*levels);
    // guardar bbox para tooltip
    barsHit.push({i,x:x,y:padT,w:bw,h:H-padT-padB,s});

    // bloques
    for(let lv=0; lv<levels; lv++){
      const yBlock=baseY - (lv+1)*bh + 2;
      ctx.fillStyle= lv<filled ? col : getComputedStyle(document.documentElement).getPropertyValue('--grid');
      ctx.globalAlpha= lv<filled ? 0.92 : 0.55;
      ctx.fillRect(x+innerPad/2, yBlock, bw, bh-4);
      ctx.globalAlpha=1;
    }

    // etiqueta superior
    ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--fg');
    ctx.font='bold 12px system-ui'; ctx.textAlign='center';
    ctx.fillText(`${pct}%`, x+colW/2, padT-2);
    ctx.font='10px system-ui';
    ctx.fillText(`${s.weighted}/${s.goal}`, x+colW/2, padT+12);

    // borde dorado + estrella si sobrecumple (raw > goal)
    if(s.raw > s.goal){
      ctx.strokeStyle='#fcd34d'; ctx.lineWidth=2;
      ctx.strokeRect(x+innerPad/2-2, padT-2, bw+4, H-padT-padB+4);
      // estrella
      const starX=x+colW/2, starY=padT-16, R=8, r=4;
      ctx.beginPath();
      for(let k=0;k<10;k++){
        const ang=Math.PI/2 + k*Math.PI/5;
        const rad = (k%2===0)?R:r;
        const px=starX + rad*Math.cos(ang);
        const py=starY - rad*Math.sin(ang);
        if(k===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
      }
      ctx.closePath(); ctx.fillStyle='#fcd34d'; ctx.strokeStyle='#a16207'; ctx.lineWidth=1;
      ctx.fill(); ctx.stroke();
    }

    // nombre hábito (x)
    ctx.textAlign='center'; ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--fg');
    ctx.font='11px system-ui';
    let nm=habits[i].name; if(nm.length>12) nm=nm.slice(0,11)+'…';
    ctx.fillText(nm, x+colW/2, H-12);
  }

  // tooltip
  const tip=QS('#tooltip');
  cnv.onmousemove=(e)=>{
    const rect=cnv.getBoundingClientRect();
    const mx=e.clientX-rect.left, my=e.clientY-rect.top;
    let hit=-1;
    for(let k=0;k<barsHit.length;k++){
      const b=barsHit[k];
      if(mx>=b.x && mx<=b.x+b.w+10 && my>=b.y && my<=b.y+b.h){ hit=k; break; }
    }
    if(hit>=0){
      const b=barsHit[hit], s=b.s, name=habits[b.i].name;
      tip.innerHTML=`<div><strong>${name}</strong></div><div>${s.pct}% (${s.weighted}/${s.goal})</div><div class="small">Crudo: ${s.raw}</div>`;
      tip.style.display='block';
      tip.style.left = `${e.clientX+12}px`;
      tip.style.top  = `${e.clientY+12}px`;
    }else{
      tip.style.display='none';
    }
  };
  cnv.onmouseleave=()=>{ QS('#tooltip').style.display='none'; };

  QS('#dlBars').onclick=()=>downloadCanvas(cnv,`barras-${y}-${pad(m+1)}.png`);
}

// ---------- Descarga canvas ----------
function downloadCanvas(cnv,fn){
  const a=document.createElement('a');
  a.href=cnv.toDataURL('image/png');
  a.download=fn; a.click();
}

// ---------- Export / Import / CSV ----------
function doBackup(){
  const dump={};
  for(const [k,v] of Object.entries(LS)){
    if(k.startsWith('habit-weekly-v3') || k==='habit-list-weekly' || k==='habit-mode' || k==='habit-view' || k==='trend-smooth'){
      dump[k]=v;
    }
  }
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([JSON.stringify(dump,null,0)],{type:'application/json'}));
  a.download='backup.json'; a.click();
}
function doImport(){
  const inp=document.createElement('input'); inp.type='file'; inp.accept='.json,application/json';
  inp.onchange=()=>{
    const f=inp.files[0]; if(!f) return;
    const fr=new FileReader();
    fr.onload=()=>{
      try{
        const obj=JSON.parse(fr.result);
        for(const k in obj) LS.setItem(k,obj[k]);
        location.reload();
      }catch(err){ alert('JSON inválido'); }
    };
    fr.readAsText(f);
  };
  inp.click();
}
function exportCSV(){
  const y=+yearSel.value, m=+monthSel.value, days=new Date(y,m+1,0).getDate();
  let out='Fecha,Día,'+habits.map(h=>'"'+h.name.replace(/"/g,'""')+'"').join(',')+'\n';
  const data=getMonthData(y,m);
  for(let d=1;d<=days;d++){
    const date=new Date(y,m,d);
    const row=[ymd(y,m,d), WD_ES[date.getDay()], ...habits.map((_,i)=>data[`${ymd(y,m,d)}:${i}`]?1:0)];
    out+=row.join(',')+'\n';
  }
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([out],{type:'text/csv'}));
  a.download=`habits-${y}-${pad(m+1)}.csv`; a.click();
}

// ---------- PWA (manifest + service worker) ----------
function setupPWA(){
  const manifest={
    name:"Habit Tracker",
    short_name:"Habits",
    start_url:"./",
    display:"standalone",
    background_color:getAccent(),
    theme_color:getAccent(),
    icons:[{
      src:`data:image/svg+xml,${encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0' x2='1'><stop offset='0' stop-color='${getAccent()}'/><stop offset='1' stop-color='#60a5fa'/></linearGradient></defs><rect width='100' height='100' fill='url(#g)'/><text x='50' y='62' text-anchor='middle' font-size='54' fill='white' font-family='Arial, sans-serif'>H</text></svg>`)}`,
      sizes:"192x192",
      type:"image/svg+xml",
      purpose:"any"
    }]
  };
  const blob=new Blob([JSON.stringify(manifest)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const link=document.createElement('link'); link.rel='manifest'; link.href=url; document.head.appendChild(link);

  if('serviceWorker' in navigator){
    const swTxt=`
      const CACHE='habits-v3';
      self.addEventListener('install',e=>{ e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./']))); });
      self.addEventListener('activate',e=>{ e.waitUntil(self.clients.claim()); });
      self.addEventListener('fetch',e=>{
        e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{
          return res;
        }).catch(()=>r)));
      });
    `;
    const swBlob=new Blob([swTxt],{type:'text/javascript'});
    const swURL=URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swURL);
  }
}

// ---------- Eventos UI ----------
QS('#modeBtn').onclick=()=>{
  mode = (mode==='light')?'dark':'light';
  document.body.dataset.mode=mode;
  LS.setItem('habit-mode',mode);
  QS('#modeBtn').textContent = (mode==='light')?'Oscuro':'Claro';
  // re-render canvases si modal abierto
  if(QS('#modal').style.display==='flex'){
    const y=+yearSel.value, m=+monthSel.value;
    drawCalendar(y,m); drawDonut(y,m); drawBars(y,m);
  }
};
QS('#toggleView').onclick=()=>{
  view = (view==='month')?'year':'month';
  LS.setItem('habit-view',view);
  QS('#toggleView').textContent = (view==='month')?'Mes':'Anual';
  QS('#toggleView').setAttribute('aria-pressed', view==='year' ? 'true' : 'false');
  refreshAll();
};
QS('#smooth').onchange=(e)=>{ smooth=+e.target.value; LS.setItem('trend-smooth',String(smooth)); QS('#smoothLabel').textContent=String(smooth); refreshAll(); };
QS('#todayBtn').onclick=()=>{ monthSel.value=String(NOW.getMonth()); yearSel.value=String(NOW.getFullYear()); view='month'; LS.setItem('habit-view',view); refreshAll(); setTimeout(scrollToToday,60); };
QS('#habitBtn').onclick=openHabitModal;
QS('#heatBtn').onclick=openHeatmap;
QS('#backupBtn').onclick=doBackup;
QS('#importBtn').onclick=doImport;
QS('#csvBtn').onclick=exportCSV;
monthSel.onchange=refreshAll; yearSel.onchange=refreshAll;

// ---------- Init ----------
setupPWA();
refreshAll();
setTimeout(scrollToToday, 120);
})();

</script>
</body>
</html>
