<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>PT Tracker ‚Äî Simple Log</title>
<meta name="theme-color" content="#0b1020">
<link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><rect width='100%' height='100%' fill='%231b5bff'/><text x='50%' y='58%' text-anchor='middle' font-family='Arial' font-size='44' fill='white'>PT</text></svg>">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin="anonymous"></script>
<style>
  :root{
    --bg:#0b1020; --panel:#10182a; --card:#141d31; --text:#e8eefc; --muted:#9aa5bd; --primary:#5ebd73;
    --danger:#ef4444; --warn:#f59e0b; --ok:#22c55e; --line:#1f2a44; --accent:#7c9cff;
    --touch:52px; --w: 460px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font:16px/1.4 -apple-system,BlinkMacSystemFont,Inter,Segoe UI,Roboto,Arial;
    display:flex; justify-content:center;
  }
  .app{width:100%; max-width:var(--w); min-height:100%; display:flex; flex-direction:column}
  header{
    position:sticky; top:0; z-index:10; backdrop-filter:saturate(1.2) blur(10px);
    background:linear-gradient(180deg, rgba(11,16,32,.95), rgba(11,16,32,.8));
    border-bottom:1px solid var(--line); padding:10px 12px;
  }
  header .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .chip{background:#0f1630; border:1px solid var(--line); padding:8px 12px; border-radius:999px; color:var(--muted); font-size:13px}
  .chip.ok{color:#68f0a7; border-color:#183a2d; background:#0b1f18}
  .chip.warn{color:#ffd26a; border-color:#3a2e18; background:#1b160b}
  .btn{
    height:var(--touch); min-width:var(--touch); padding:0 16px; border-radius:14px; border:1px solid var(--line);
    background:#0f1731; color:var(--text); cursor:pointer; font-size:16px; font-weight:600
  }
  .btn.primary{background:linear-gradient(180deg,#1c6b42,#155b38); border-color:#0d3b24}
  .btn.small{height:40px; padding:0 12px; border-radius:10px; font-size:14px; font-weight:500}
  .btn.block{width:100%}
  .grid{display:grid; gap:12px}
  .panel{background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:12px}
  .card{background:var(--card); border:1px solid var(--line); border-radius:16px; padding:12px}
  .row{display:flex; gap:12px; align-items:center}
  .grow{flex:1}
  .right{margin-left:auto}
  label{color:var(--muted); font-size:13px; display:block; margin-bottom:6px}
  input, select, textarea{
    width:100%; background:#0e162e; color:var(--text); border:1px solid var(--line);
    border-radius:14px; padding:12px 14px; height:48px; outline:none; font-size:16px
  }
  textarea{min-height:92px; resize:vertical}
  .muted{color:var(--muted)}
  main{flex:1; padding:12px 12px 88px}
  section[hidden]{display:none !important}

  /* NAV inferior */
  nav.tabs{
    position:sticky; bottom:0; z-index:10; border-top:1px solid var(--line);
    background:linear-gradient(180deg, rgba(11,16,32,.85), rgba(11,16,32,.95));
    display:grid; grid-template-columns:repeat(5,1fr);
  }
  nav.tabs button{appearance:none; border:none; background:transparent; color:var(--muted); padding:8px 4px; height:70px; cursor:pointer; font-size:12px}
  nav.tabs button.active{color:#bfe9ff}
  nav.tabs .ico{display:block; font-size:18px}

  /* Calendario compacto (heatmap) */
  .cal{display:grid; grid-template-columns:repeat(7, 1fr); gap:6px}
  .cal .dow{height:22px; display:flex; align-items:center; justify-content:center; color:var(--muted); font-size:12px}
  .cal .day{aspect-ratio:1/1; display:flex; align-items:center; justify-content:center; border-radius:10px; font-size:13px; user-select:none;
    border:1px solid #1a2543; background:#0e162e; cursor:pointer}
  .cal .day.today{outline:2px solid var(--accent)}
  .cal .day.sel{outline:2px solid var(--primary)}
  .legend{display:flex; gap:8px; align-items:center}
  .legend .sw{width:18px; height:12px; border-radius:4px; border:1px solid var(--line)}

  /* Simple Add */
  .simple label b{color:#eaf0ff}
  .hint{font-size:12px; color:var(--muted)}
  .exitem{display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid var(--line)}
  .exitem:last-child{border-bottom:none}
  .exname{font-weight:600}
  .exmeta{color:var(--muted); font-size:13px}

  /* Slider "c√≥mo me sent√≠" */
  .feel-wrap{padding:10px; border-radius:14px; border:1px solid var(--line); background:#0e162e}
  .feel-row{display:flex; align-items:center; gap:12px}
  .feel-emoji{font-size:22px; width:32px; text-align:center}
  input[type="range"]{width:100%}
  .feel-chip{display:inline-block; padding:4px 8px; border:1px solid var(--line); border-radius:999px; font-size:12px; color:#cbe0ff}

  /* Print */
  @media print{
    nav.tabs, header{display:none !important}
    body{background:#fff; color:#000}
    .panel, .card{border-color:#ddd}
  }
</style>
</head>
<body>
<div class="app" role="application" aria-label="PT Tracker">
  <header>
    <div class="row" role="toolbar" aria-label="Barra superior">
      <button id="btnToday" class="btn small" aria-label="Ir a hoy">Hoy</button>
      <div class="chip" id="ctxDateChip" role="button" aria-label="Fecha">üìÖ <span id="ctxDateLabel">‚Äî</span></div>
      <div class="chip ok right" id="metaChip">Meta mes: ‚Äî</div>
      <span class="muted" id="saveState">‚Ä¢ sin guardar</span>
    </div>
  </header>

  <main>
    <!-- ===== Registrar (Simple Log) ===== -->
    <section id="tab-registrar" aria-label="Registrar sesi√≥n">
      <div class="grid">
        <!-- Calendario compacto arriba -->
        <div class="card" id="miniCalCard">
          <div class="cal" id="miniCal">
            <div class="dow">L</div><div class="dow">M</div><div class="dow">X</div><div class="dow">J</div><div class="dow">V</div><div class="dow">S</div><div class="dow">D</div>
          </div>
          <div class="row legend" style="margin-top:8px">
            <span class="muted">Intensidad:</span>
            <span class="sw" style="background:#0e162e"></span>
            <span class="sw" style="background:#0f3a1e"></span>
            <span class="sw" style="background:#156034"></span>
            <span class="sw" style="background:#1f8b50"></span>
            <span class="sw" style="background:#27b96b"></span>
          </div>
        </div>

        <div class="panel">
          <div class="row">
            <div class="grow">
              <label for="bodyWeight"><b>Peso corporal (kg)</b></label>
              <input id="bodyWeight" type="number" step="0.1" min="20" max="300" />
            </div>
            <button class="btn small" id="btnNewToday">Nuevo (hoy)</button>
            <button class="btn small" id="btnLoadBase">Cargar base</button>
            <button class="btn small" id="btnSave">Guardar</button>
          </div>
        </div>

        <!-- SIMPLE ADD (escribes series y kilos) -->
        <div class="card simple" id="simpleAdd">
          <label><b>Agregar ejercicio</b> <span class="hint">Nombre ‚Üí Series (reps) ‚Üí Pesos (kg) ‚Üí A√±adir</span></label>
          <div class="grid">
            <div>
              <label for="saType">Tipo</label>
              <select id="saType">
                <option value="fuerza">Fuerza</option>
                <option value="cardio">Cardio</option>
              </select>
            </div>
            <div>
              <label for="saName">Nombre de ejercicio</label>
              <input id="saName" list="exList" placeholder="Ej: Press de pecho (m√°quina)">
              <datalist id="exList"></datalist>
            </div>
            <div id="saFuerzaBlock">
              <div>
                <label for="saReps">Series (reps)</label>
                <input id="saReps" placeholder="Ej: 12-12-10-10 √≥ 12,12,10,10" inputmode="numeric">
              </div>
              <div>
                <label for="saWeights">Pesos (kg)</label>
                <input id="saWeights" placeholder="Ej: 55-55-60-60 (step 0.5)" inputmode="decimal">
              </div>
              <div>
                <label for="saCat">Categor√≠a</label>
                <select id="saCat">
                  <option>Empuje</option><option>Jale</option><option>Aislamiento</option>
                  <option>Pierna</option><option>Core</option>
                </select>
              </div>
            </div>
            <div id="saCardioBlock" hidden>
              <div>
                <label for="saSpeed">Velocidad (km/h)</label>
                <input id="saSpeed" type="number" step="0.1" inputmode="decimal" placeholder="Ej: 6">
              </div>
              <div>
                <label for="saGrade">Inclinaci√≥n (%)</label>
                <input id="saGrade" type="number" step="1" inputmode="numeric" placeholder="Ej: 6">
              </div>
              <div>
                <label for="saMinutes">Minutos</label>
                <input id="saMinutes" type="number" step="1" inputmode="numeric" placeholder="Ej: 10">
              </div>
            </div>
            <button id="saAdd" class="btn primary block">A√±adir</button>
            <div class="hint" id="saHint">Serie #1</div>
          </div>
        </div>

        <!-- Listado del d√≠a + resumen + c√≥mo me sent√≠ + nota -->
        <div class="card">
          <label><b>Sesi√≥n del d√≠a</b></label>
          <div id="dayList"></div>

          <div class="panel" style="margin-top:10px">
            <label><b>C√≥mo me sent√≠</b> <span class="hint">(1=candado üîí / 10=üî• s√∫per fuerte)</span></label>
            <div class="feel-wrap">
              <div class="feel-row">
                <div class="feel-emoji" id="feelEmoji">üòê</div>
                <input type="range" id="feelRange" min="1" max="10" step="1" value="7" aria-label="C√≥mo me sent√≠">
                <span class="feel-chip" id="feelLabel">7 / 10</span>
              </div>
            </div>
          </div>

          <div class="panel" style="margin-top:10px">
            <label><b>Resumen</b></label>
            <progress id="prog" max="100" value="0" style="width:100%; height:12px"></progress>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
              <span class="chip">Cumplimiento: <b id="progPct">0%</b></span>
              <span class="chip">Kcal: <b id="kcalTotal">0</b></span>
              <span class="chip" id="miniText">‚Äî</span>
            </div>
          </div>

          <div class="panel" style="margin-top:10px">
            <label for="note"><b>Notas de salud / comentarios</b></label>
            <textarea id="note" placeholder="Ej: rodilla OK, respiraci√≥n nasal, etc."></textarea>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== Calendario ===== -->
    <section id="tab-calendario" hidden aria-label="Calendario">
      <div class="grid">
        <div class="card">
          <div class="row" style="flex-wrap:wrap">
            <button class="btn small" id="monPrev">‚óÄ</button>
            <div class="chip" id="monLabel">‚Äî</div>
            <button class="btn small" id="monNext">‚ñ∂</button>
          </div>
          <div style="height:8px"></div>
          <div class="cal" id="heatGrid" aria-label="Calendario heatmap" role="grid">
            <div class="dow">L</div><div class="dow">M</div><div class="dow">X</div><div class="dow">J</div><div class="dow">V</div><div class="dow">S</div><div class="dow">D</div>
          </div>
          <div class="row legend" style="margin-top:8px">
            <span class="muted">Intensidad:</span>
            <span class="sw" style="background:#0e162e"></span>
            <span class="sw" style="background:#0f3a1e"></span>
            <span class="sw" style="background:#156034"></span>
            <span class="sw" style="background:#1f8b50"></span>
            <span class="sw" style="background:#27b96b"></span>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== Gr√°ficos ===== -->
    <section id="tab-graficos" hidden aria-label="Anal√≠tica por ejercicio">
      <div class="grid">
        <div class="card">
          <div class="row">
            <div class="grow">
              <label for="exSelectAnalitica">Ejercicio</label>
              <select id="exSelectAnalitica"></select>
            </div>
            <div>
              <label>&nbsp;</label>
              <div class="row">
                <button class="btn small" data-metric="vol" id="btnVol">Volumen</button>
                <button class="btn small" data-metric="top" id="btnTop">Mejor set</button>
                <button class="btn small" data-metric="epley" id="btnEpley">1RM</button>
              </div>
            </div>
          </div>
          <canvas id="exChart" height="220"></canvas>
        </div>
      </div>
    </section>

    <!-- ===== Metas ===== -->
    <section id="tab-metas" hidden aria-label="Metas mensuales">
      <div class="grid">
        <div class="card">
          <label>Progreso vs Meta (mes actual)</label>
          <canvas id="goalsChart" height="220"></canvas>
        </div>
        <div class="panel">
          <div class="row" style="flex-wrap:wrap">
            <button class="btn small" id="btnSetGoal">Editar meta del mes</button>
            <div class="chip ok" id="goalBadge">Meta: ‚Äî</div>
          </div>
          <div style="height:8px"></div>
          <label>Texto gu√≠a</label>
          <div id="goalText" class="muted" style="white-space:pre-wrap"></div>
        </div>
      </div>
    </section>

    <!-- ===== Exportar ===== -->
    <section id="tab-exportar" hidden aria-label="Exportar e importar">
      <div class="grid">
        <div class="card">
          <label>CSV</label>
          <div class="row" style="flex-wrap:wrap">
            <button class="btn" id="csvDay">Exportar D√≠a</button>
            <button class="btn" id="csvMonth">Exportar Mes</button>
            <button class="btn" id="csvAll">Exportar Total</button>
          </div>
          <div class="row" style="margin-top:8px">
            <input type="file" id="csvImport" accept=".csv" aria-label="Importar CSV del d√≠a">
            <button class="btn" id="btnImport">Importar CSV del d√≠a</button>
          </div>
        </div>
        <div class="card">
          <label>Dashboard</label>
          <div class="row" style="flex-wrap:wrap">
            <button class="btn" id="btnPNG">Descargar Dashboard PNG</button>
            <button class="btn" id="btnPDF">Imprimir / PDF</button>
          </div>
          <canvas id="dashCanvas" height="240" style="margin-top:10px"></canvas>
        </div>
        <div class="panel" id="datosDuros">
          <label>Datos duros (d√≠a actual)</label>
          <div id="rawDay"></div>
        </div>
      </div>
    </section>
  </main>

  <nav class="tabs" role="tablist" aria-label="Pesta√±as">
    <button class="active" data-tab="registrar" role="tab" aria-controls="tab-registrar" aria-selected="true"><span class="ico">üìù</span>Registrar</button>
    <button data-tab="calendario" role="tab" aria-controls="tab-calendario" aria-selected="false"><span class="ico">üìÜ</span>Calendario</button>
    <button data-tab="graficos" role="tab" aria-controls="tab-graficos" aria-selected="false"><span class="ico">üìà</span>Gr√°ficos</button>
    <button data-tab="metas" role="tab" aria-controls="tab-metas" aria-selected="false"><span class="ico">üéØ</span>Metas</button>
    <button data-tab="exportar" role="tab" aria-controls="tab-exportar" aria-selected="false"><span class="ico">‚§¥Ô∏è</span>Exportar</button>
  </nav>
</div>

<script>
/** =========================
 *  PT Tracker ‚Äî Simple Log
 *  - Registro tipo "nota": escribes series y kilos
 *  - Sin steppers; inputs libres
 *  - Slider de "c√≥mo me sent√≠" 1‚Äì10 con emojis/colores
 *  - Recuerda √∫ltimo peso por ejercicio
 *  - DRAFT en memoria para no perder lo a√±adido
 *  ========================= */

// ---------- Utilidades de fecha ----------
const fmt = (d)=> d.toISOString().slice(0,10);
const today = ()=> { const t = new Date(); t.setHours(12,0,0,0); return t; };
const ymdToDate = (s)=> { const [Y,M,D]=s.split('-').map(Number); const d=new Date(Y, M-1, D); d.setHours(12,0,0,0); return d; };
const ym = (d)=> `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
const startOfMonth = (d)=> new Date(d.getFullYear(), d.getMonth(), 1);
const endOfMonth = (d)=> new Date(d.getFullYear(), d.getMonth()+1, 0);

// ---------- Claves y estado ----------
const LS = {
  workouts: 'pt_workouts_v2',
  exercises: 'pt_exercises_v2',
  goals: 'pt_goals_v2',
  base: 'pt_base_v2',
  lastWeights: 'pt_last_weights_v1'
};
let ctxDate = today();
let charts = { goals:null, ex:null };
let dirty = false;
let workDraft = null; // sesi√≥n en edici√≥n

// ---------- Semillas ----------
const SEED_EX = [
  {exId:'ex_press_pecho_maquina', name:'Press pecho (m√°quina)', category:'Empuje'},
  {exId:'ex_remo_sentado_polea', name:'Remo sentado (polea)', category:'Jale'},
  {exId:'ex_curl_biceps_maquina', name:'Curl b√≠ceps (m√°quina)', category:'Aislamiento'},
  {exId:'ex_jalon_cerrado', name:'Jal√≥n polea (agarre cerrado)', category:'Jale'},
  {exId:'ex_press_hombros_maquina', name:'Press hombros (m√°quina)', category:'Empuje'},
  {exId:'ex_crunch_hummett', name:'Crunch en m√°quina (Hummett)', category:'Core'},
  {exId:'ex_extension_piernas', name:'Extensi√≥n de piernas', category:'Pierna'},
  {exId:'ex_rdl_barra', name:'Peso muerto rumano (barra)', category:'Pierna'},
  {exId:'ex_cinta', name:'Cinta (cardio)', category:'Cardio'},
];
const AUG_TEXT = `Asistencia: ‚â•10 sesiones (√≥ptimo 12‚Äì13).
Cargas/volumen (fin de agosto):
- Press pecho: 4√ó(12‚Äì12‚Äì10‚Äì10) con 55‚Äì55‚Äì57.5‚Äì57.5 kg (RPE 8‚Äì9 √∫ltima).
- Remo sentado: 4√ó12 con 54‚Äì54‚Äì56‚Äì56 kg (o 1‚Äì2 series a 56 kg).
- Curl b√≠ceps: 40 kg en ‚â•3√ó12 (RPE 8).
- Jal√≥n cerrado: 4√ó(12‚Äì12‚Äì10‚Äì10) con 42.5‚Äì45 kg.
- Press hombros: 4√ó10 con 32.5‚Äì35‚Äì35‚Äì35 kg.
- Crunch: 4√ó15 con 35 kg (√∫ltimas 2 a 37.5 kg si c√≥modo).
- Extensi√≥n de piernas: 3√ó15 con 40 kg (2s iso arriba).
- RDL: 3√ó12 con 32.5‚Äì35 kg (t√©cnica/rodilla OK).
RPE: promedio 7‚Äì8; ‚â•1 top set a RPE 8‚Äì9 por ejercicio clave.
Cardio: 10‚Ä≤ post fuerza @ 6 km/h, 7% ‚Üí ‚â•80% de sesiones.
Rodilla: 0 dolor; sin correr; OK caminata inclinada; priorizar RDL t√©cnico + extensiones; movilidad.`;
const SEED_BASE_AUG = [
  { exId:'ex_cinta', name:'Cinta (cardio)', category:'Cardio', sets:[{speed:5.5, grade:6, minutes:8, rpe:6}] },
  { exId:'ex_press_pecho_maquina', name:'Press pecho (m√°quina)', category:'Empuje', sets:[{weight:50,reps:12,rpe:7},{weight:52.5,reps:12,rpe:7.5},{weight:52.5,reps:10,rpe:8},{weight:55,reps:10,rpe:8}] },
  { exId:'ex_remo_sentado_polea', name:'Remo sentado (polea)', category:'Jale', sets:[{weight:52,reps:12,rpe:7},{weight:52,reps:12,rpe:7.5},{weight:54,reps:10,rpe:8},{weight:54,reps:10,rpe:8}] },
  { exId:'ex_curl_biceps_maquina', name:'Curl b√≠ceps (m√°quina)', category:'Aislamiento', sets:[{weight:35,reps:12,rpe:7},{weight:35,reps:12,rpe:7.5},{weight:37.5,reps:12,rpe:8},{weight:37.5,reps:12,rpe:8}] },
  { exId:'ex_jalon_cerrado', name:'Jal√≥n polea (agarre cerrado)', category:'Jale', sets:[{weight:40,reps:12,rpe:7},{weight:40,reps:12,rpe:7.5},{weight:40,reps:10,rpe:8},{weight:40,reps:10,rpe:8}] },
  { exId:'ex_press_hombros_maquina', name:'Press hombros (m√°quina)', category:'Empuje', sets:[{weight:30,reps:12,rpe:7},{weight:30,reps:12,rpe:7.5},{weight:32.5,reps:10,rpe:8},{weight:32.5,reps:10,rpe:8}] },
  { exId:'ex_crunch_hummett', name:'Crunch en m√°quina (Hummett)', category:'Core', sets:[{weight:30,reps:15,rpe:7},{weight:30,reps:15,rpe:7},{weight:30,reps:15,rpe:7.5},{weight:35,reps:15,rpe:8}] },
  { exId:'ex_extension_piernas', name:'Extensi√≥n de piernas', category:'Pierna', sets:[{weight:35,reps:15,rpe:7},{weight:35,reps:12,rpe:7.5},{weight:35,reps:12,rpe:8}] },
  { exId:'ex_rdl_barra', name:'Peso muerto rumano (barra)', category:'Pierna', sets:[{weight:30,reps:12,rpe:7},{weight:30,reps:12,rpe:7.5},{weight:30,reps:12,rpe:8}] },
  { exId:'ex_cinta', name:'Cinta (cardio)', category:'Cardio', sets:[{speed:6, grade:7, minutes:10, rpe:7}] },
];

// ---------- Storage helpers ----------
const readLS = (k, def)=> { try{ const v = JSON.parse(localStorage.getItem(k)); return v ?? def; } catch(e){ return def; } };
const writeLS = (k, v)=> localStorage.setItem(k, JSON.stringify(v));
function ensureSeeds(){
  if(!readLS(LS.exercises)) writeLS(LS.exercises, SEED_EX);
  if(!readLS(LS.workouts)) writeLS(LS.workouts, []);
  if(!readLS(LS.goals)) writeLS(LS.goals, {});
  if(!readLS(LS.base)) writeLS(LS.base, SEED_BASE_AUG);
  if(!readLS(LS.lastWeights)) writeLS(LS.lastWeights, {});
}
ensureSeeds();

const getWorkouts = ()=> readLS(LS.workouts, []);
const setWorkouts = (arr)=> writeLS(LS.workouts, arr);
const getExercises = ()=> readLS(LS.exercises, []);
const setExercises = (arr)=> writeLS(LS.exercises, arr);
const getGoals = ()=> readLS(LS.goals, {});
const setGoals = (obj)=> writeLS(LS.goals, obj);
const getBase = ()=> readLS(LS.base, []);
const setBase = (items)=> writeLS(LS.base, items);
const getLastWeights = ()=> readLS(LS.lastWeights, {});
const setLastWeights = (obj)=> writeLS(LS.lastWeights, obj);

const defaultWorkout = (date)=> ({ id:'w_'+date, date, bodyWeight:74, note:'', feel:7, items:[], indicators:{volume_total_kg:0, topSet:0, rpeAvg:0, cardioMin:0} });

// ---------- C√°lculos ----------
function kcalCardioSet(speed_kmh, incline_pct, minutes, bw){
  const v = speed_kmh * 1000 / 60; const grade = (incline_pct||0)/100;
  const VO2 = 3.5 + 0.1*v + 1.8*v*grade;
  const kcal = (VO2 * bw / 200) * minutes;
  return isFinite(kcal)? kcal : 0;
}
function kcalStrengthSet(rpe, bw){
  const MET = (rpe>=8)? 6 : 4.5; const minutes = 1.75;
  const kcal = MET*3.5*bw/200*minutes;
  return isFinite(kcal)? kcal : 0;
}
function epley1RM(w, r){ return (w && r)? w*(1+r/30):0; }
function countBaseSets(){ return getBase().reduce((a,b)=> a+(b.sets?.length||0),0); }
function computeIndicators(workout){
  let vol=0, top=0, rpeList=[], cardioMin=0, kcal=0, doneCount=0, baseTotalSets=countBaseSets();
  const bw = Number(workout.bodyWeight||74);
  for(const it of workout.items){
    if(it.category==='Cardio'){
      for(const s of it.sets){
        if(!isFinite(Number(s.minutes))) continue;
        cardioMin += Number(s.minutes)||0;
        kcal += kcalCardioSet(Number(s.speed||0), Number(s.grade||0), Number(s.minutes||0), bw);
        if(s.done) doneCount++;
      }
    }else{
      for(const s of it.sets){
        const W=Number(s.weight||0), R=Number(s.reps||0), E=Number(s.rpe||workout.feel||7);
        vol += W*R; top=Math.max(top,W);
        if(E) rpeList.push(E);
        kcal += kcalStrengthSet(E, bw);
        if(s.done) doneCount++;
      }
    }
  }
  const rpeAvg = rpeList.length? (rpeList.reduce((a,b)=>a+b,0)/rpeList.length) : 0;
  const progPct = baseTotalSets? Math.round((doneCount/baseTotalSets)*100) : 0;
  workout.indicators = { volume_total_kg: Math.round(vol), topSet: top, rpeAvg: Number(rpeAvg.toFixed(2)), cardioMin: Math.round(cardioMin) };
  return { kcalTotal: Math.round(kcal), progPct, doneCount, baseTotalSets };
}

// ---------- UI helpers ----------
const el = (id)=> document.getElementById(id);
function markDirty(v=true){ dirty=v; el('saveState').textContent = v? '‚Ä¢ cambios sin guardar' : '‚Ä¢ guardado'; }
function setCtxDate(d){
  ctxDate = d;
  el('ctxDateLabel').textContent = fmt(d);
  el('monLabel').textContent = d.toLocaleString('es-CL', {month:'long', year:'numeric'});
  const wos = getWorkouts();
  const found = wos.find(w=> w.date===fmt(ctxDate));
  workDraft = found ? JSON.parse(JSON.stringify(found)) : defaultWorkout(fmt(ctxDate));
  refreshAll();
}

// ---------- Cat√°logo ----------
function buildExerciseCatalogDatalist(){
  const dl = el('exList'); dl.innerHTML='';
  getExercises().forEach(e=>{ const o=document.createElement('option'); o.value=e.name; dl.appendChild(o); });
}
buildExerciseCatalogDatalist();
function findOrCreateExercise(name, category){
  const exs = getExercises();
  let ex = exs.find(x=> x.name.toLowerCase()===name.toLowerCase());
  if(!ex){ ex = {exId:'ex_'+Date.now(), name, category}; exs.push(ex); setExercises(exs); buildExerciseCatalogDatalist(); }
  return ex;
}

// ---------- Simple Add ----------
function parseList(str){
  if(!str) return [];
  return str.split(/[\s,;‚Äì‚Äî-]+/).map(s=> s.trim()).filter(Boolean);
}
function addStrengthByLists(name, cat, repsStr, weightsStr){
  const repsList = parseList(repsStr).map(n=> parseInt(n,10) || 0);
  let wList = parseList(weightsStr).map(n=> parseFloat(n.replace(',','.')) || 0);
  if(repsList.length===0) throw new Error('Debes indicar al menos 1 serie en "Series (reps)".');
  if(wList.length===0) throw new Error('Debes indicar al menos 1 peso en "Pesos (kg)".');
  // Si hay 1 peso, se aplica a todas las series; si hay menos, completa con √∫ltimo
  while(wList.length < repsList.length) wList.push(wList[wList.length-1]);
  const ex = findOrCreateExercise(name, cat);
  let it = workDraft.items.find(i=> i.exId===ex.exId);
  if(!it){ it = { exId:ex.exId, name:ex.name, category:cat, sets:[] }; workDraft.items.push(it); }
  repsList.forEach((r, idx)=> it.sets.push({weight:round05(wList[idx]), reps:r, rpe:workDraft.feel||7}));
  // recordar √∫ltimo peso
  const lw = getLastWeights(); lw[ex.exId] = round05(wList[wList.length-1]); setLastWeights(lw);
}
function addCardio(name, speed, grade, minutes){
  const ex = findOrCreateExercise(name, 'Cardio');
  let it = workDraft.items.find(i=> i.exId===ex.exId);
  if(!it){ it = { exId:ex.exId, name:ex.name, category:'Cardio', sets:[] }; workDraft.items.push(it); }
  it.sets.push({speed:toNum(speed), grade:toNum(grade), minutes:toInt(minutes), rpe:workDraft.feel||7});
}
function initSimpleAdd(){
  const t = el('saType');
  const fuerza = ()=> { el('saFuerzaBlock').hidden=false; el('saCardioBlock').hidden=true; };
  const cardio = ()=> { el('saFuerzaBlock').hidden=true; el('saCardioBlock').hidden=false; };
  t.addEventListener('change', ()=> t.value==='cardio'? cardio(): fuerza());
  fuerza();

  const nameI = el('saName');
  nameI.addEventListener('change', ()=>{
    const name = nameI.value.trim().toLowerCase();
    const ex = getExercises().find(e=> e.name.toLowerCase()===name);
    if(ex){
      // prellenar √∫ltimo peso
      const lw = getLastWeights(); if(lw[ex.exId]!=null) el('saWeights').value = String(lw[ex.exId]);
      updateSAHint();
    }
  });

  el('saAdd').addEventListener('click', ()=>{
    const type = t.value;
    const name = nameI.value.trim();
    if(!name){ alert('Escribe el nombre del ejercicio'); return; }

    try{
      if(type==='cardio'){
        const sp = el('saSpeed').value, gr=el('saGrade').value, min=el('saMinutes').value;
        if(!min || Number(min)<=0) throw new Error('Minutos debe ser > 0');
        addCardio(name, sp, gr, min);
        el('saSpeed').value=''; el('saGrade').value=''; el('saMinutes').value='';
      }else{
        const reps = el('saReps').value;
        const w    = el('saWeights').value;
        const cat  = el('saCat').value;
        addStrengthByLists(name, cat, reps, w);
        el('saReps').value=''; // deja el √∫ltimo peso por comodidad
      }
      renderDayList(); updateSummary(workDraft); markDirty(); updateSAHint();
    }catch(e){ alert(e.message); }
  });
  updateSAHint();
}
function updateSAHint(){
  const name = (el('saName').value||'').trim();
  let n = 1;
  if(name && workDraft){
    const ex = getExercises().find(e=> e.name.toLowerCase()===name.toLowerCase());
    if(ex){
      const it = workDraft.items.find(i=> i.exId===ex.exId);
      if(it) n = (it.sets?.length||0)+1;
    }
  }
  el('saHint').textContent = `Serie #${n}`;
}
function round05(v){
  const x = Math.round((Number(v)||0)*2)/2; // m√∫ltiplos de 0.5
  return Number(x.toFixed(2));
}
function toNum(v){ const x=Number(String(v).replace(',','.')); return isFinite(x)? x:0; }
function toInt(v){ const x=parseInt(v,10); return isFinite(x)? x:0; }

// ---------- Listado del d√≠a ----------
function renderDayList(){
  const wrap = el('dayList'); wrap.innerHTML='';
  let exCount=0;
  workDraft.items.forEach(it=>{
    exCount++;
    const div = document.createElement('div'); div.className='exitem';
    const left = document.createElement('div');
    const name = document.createElement('div'); name.className='exname'; name.textContent = `${it.name} [${it.category}]`;
    const meta = document.createElement('div'); meta.className='exmeta';
    if(it.category==='Cardio'){
      const mins = it.sets.reduce((a,s)=>a+(Number(s.minutes||0)),0);
      meta.textContent = `${it.sets.length} set(s) ‚Ä¢ ${mins} min`;
    }else{
      const vol = it.sets.reduce((a,s)=>a+(Number(s.weight||0)*Number(s.reps||0)),0);
      const top = it.sets.reduce((m,s)=> Math.max(m, Number(s.weight||0)), 0);
      // agrega mini patr√≥n si las reps var√≠an
      const repsStr = it.sets.map(s=> s.reps||0).join('-');
      const wStr = it.sets.map(s=> s.weight||0).join('-');
      meta.textContent = `${it.sets.length} set(s) ‚Ä¢ ${repsStr} reps ‚Ä¢ ${wStr} kg ‚Ä¢ Vol ${vol} kg ‚Ä¢ Top ${top} kg`;
    }
    left.append(name, meta);
    const right = document.createElement('div');
    const rm = document.createElement('button'); rm.className='btn small'; rm.textContent='Quitar';
    rm.addEventListener('click', ()=>{
      workDraft.items = workDraft.items.filter(x=> x!==it);
      renderDayList(); updateSummary(workDraft); markDirty();
    });
    right.append(rm);
    div.append(left,right);
    wrap.appendChild(div);
  });
  el('miniText').textContent = `${fmt(ctxDate)} ‚Ä¢ ${exCount} ejercicios`;
}

// ---------- Mini calendario (registrar) ----------
function buildMiniCal(){
  const cont = el('miniCal');
  Array.from(cont.querySelectorAll('.day')).forEach(n=>n.remove());
  const base = new Date(ctxDate.getFullYear(), ctxDate.getMonth(), 1);
  const firstDow = ((base.getDay()||7)-1);
  for(let i=0;i<firstDow;i++){ const f=document.createElement('div'); f.className='day na'; f.style.visibility='hidden'; cont.appendChild(f); }
  const total = endOfMonth(ctxDate).getDate();
  const wos = getWorkouts();
  const monthStr = ym(ctxDate);
  for(let d=1; d<=total; d++){
    const dateStr = `${monthStr}-${String(d).padStart(2,'0')}`;
    const w = wos.find(x=>x.date===dateStr);
    const {kcal, color} = (()=>{
      if(!w) return {kcal:0, color:'#0e162e'};
      const c = computeIndicators(JSON.parse(JSON.stringify(w)));
      const k = c.kcalTotal;
      let col='#0f3a1e'; if(k>700) col='#27b96b'; else if(k>400) col='#1f8b50'; else if(k>200) col='#156034';
      return {kcal:k, color:col};
    })();
    const cell = document.createElement('div'); cell.className='day'; cell.textContent=d; cell.style.background=color;
    if(dateStr===fmt(today())) cell.classList.add('today');
    if(dateStr===fmt(ctxDate)) cell.classList.add('sel');
    cell.title = w? `Kcal: ${kcal}` : 'Sin sesi√≥n';
    cell.addEventListener('click', ()=> setCtxDate(ymdToDate(dateStr)) );
    cont.appendChild(cell);
  }
}

// ---------- Heatmap pesta√±a Calendario ----------
function buildHeatmap(){
  const cont = el('heatGrid'); cont.querySelectorAll('.day').forEach(n=>n.remove());
  const base = new Date(ctxDate.getFullYear(), ctxDate.getMonth(), 1);
  const firstDow = ((base.getDay()||7)-1);
  for(let i=0;i<firstDow;i++){ const f=document.createElement('div'); f.className='day na'; cont.appendChild(f); }
  const total = endOfMonth(ctxDate).getDate();
  const wos = getWorkouts(); const monthStr = ym(ctxDate);
  for(let d=1; d<=total; d++){
    const dateStr = `${monthStr}-${String(d).padStart(2,'0')}`;
    const w = wos.find(x=>x.date===dateStr);
    const {kcal, color} = (()=>{
      if(!w) return {kcal:0, color:'#0e162e'};
      const c = computeIndicators(JSON.parse(JSON.stringify(w)));
      const k = c.kcalTotal;
      let col='#0f3a1e'; if(k>700) col='#27b96b'; else if(k>400) col='#1f8b50'; else if(k>200) col='#156034';
      return {kcal:k, color:col};
    })();
    const cell = document.createElement('div'); cell.className='day'; cell.textContent=d;
    cell.style.background=color;
    if(dateStr===fmt(today())) cell.classList.add('today');
    if(dateStr===fmt(ctxDate)) cell.classList.add('sel');
    cell.title = w? `Kcal: ${kcal}` : 'Sin sesi√≥n';
    cell.addEventListener('click', ()=> setCtxDate(ymdToDate(dateStr)) );
    cont.appendChild(cell);
  }
}

// ---------- Metas ----------
function getMonthGoal(mstr){
  const g = getGoals();
  if(!g[mstr]){
    g[mstr] = {
      days: 12, volume: 15000, cardioRateTarget:0.8,
      rpeTarget:{avgMin:7,avgMax:8,topSet:true},
      goalText: AUG_TEXT
    };
    setGoals(g);
  }
  return g[mstr];
}
function buildGoalsChart(){
  const m = ym(ctxDate);
  const goal = getMonthGoal(m);
  el('goalText').textContent = goal.goalText || AUG_TEXT;
  el('goalBadge').textContent = `Meta mes: ${goal.days} d√≠as ‚Ä¢ Cardio ‚â•${Math.round(goal.cardioRateTarget*100)}%`;
  const wos = getWorkouts().filter(w=> w.date.startsWith(m));
  const asistencia = new Set(wos.map(w=>w.date)).size;
  let vol = 0, cardioOk=0;
  wos.forEach(w=>{
    const ww = JSON.parse(JSON.stringify(w)); computeIndicators(ww);
    vol += ww.indicators.volume_total_kg;
    if(ww.indicators.cardioMin>=10) cardioOk += 1;
  });
  const cardioPct = wos.length? Math.round((cardioOk/wos.length)*100) : 0;

  const data = {
    labels: ['Asistencia (d√≠as)','Volumen (kg)','Cardio (%)'],
    datasets: [
      { label:'Progreso', data:[asistencia, vol, cardioPct]},
      { label:'Meta', data:[goal.days, goal.volume, Math.round(goal.cardioRateTarget*100)]}
    ]
  };
  const ctx = el('goalsChart').getContext('2d');
  if(charts.goals) charts.goals.destroy();
  charts.goals = new Chart(ctx, { type:'bar', data, options:{ responsive:true, scales:{y:{beginAtZero:true}}, plugins:{legend:{display:true}} } });
  const ok = asistencia>=Math.min(goal.days, goal.days-2);
  el('metaChip').className = 'chip ' + (ok? 'ok':'warn');
  el('metaChip').textContent = `Meta mes: ${asistencia}/${goal.days} d√≠as`;
}

// ---------- Anal√≠tica ----------
function collectExerciseNames(){
  const setNames = new Set();
  getExercises().forEach(e=> setNames.add(e.name));
  getWorkouts().forEach(w=> w.items.forEach(it=> setNames.add(it.name)));
  return Array.from(setNames).sort((a,b)=> a.localeCompare(b,'es'));
}
function populateAnaliticaSelect(){
  const sel = el('exSelectAnalitica'); sel.innerHTML='';
  collectExerciseNames().forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); });
}
let currentMetric='vol';
['btnVol','btnTop','btnEpley'].forEach(id=> el(id).addEventListener('click', e=>{ currentMetric=e.target.dataset.metric; updateExerciseChart(); }));
el('exSelectAnalitica').addEventListener('change', updateExerciseChart);
function updateExerciseChart(){
  const name = el('exSelectAnalitica').value;
  const wos = getWorkouts().slice().sort((a,b)=> a.date.localeCompare(b.date));
  const labels=[], data=[];
  for(const w of wos){
    const it = w.items.find(i=>i.name===name);
    if(!it) continue;
    labels.push(w.date);
    if(currentMetric==='vol'){
      let v=0; if(it.category==='Cardio'){ v = (it.sets||[]).reduce((a,s)=>a+Number(s.minutes||0),0); }
      else v = (it.sets||[]).reduce((a,s)=>a+(Number(s.weight||0)*Number(s.reps||0)),0);
      data.push(v);
    }else if(currentMetric==='top'){
      let top=0; if(it.category==='Cardio'){ top = Math.max(...it.sets.map(s=> Number(s.speed||0)), 0); }
      else top = Math.max(...it.sets.map(s=> Number(s.weight||0)), 0);
      data.push(top);
    }else{
      let best=0; if(it.category!=='Cardio') for(const s of it.sets){ best = Math.max(best, epley1RM(Number(s.weight||0), Number(s.reps||0))); }
      data.push(Math.round(best));
    }
  }
  const ctx = el('exChart').getContext('2d');
  if(charts.ex) charts.ex.destroy();
  charts.ex = new Chart(ctx, { type:'line', data:{labels, datasets:[{label:name||'‚Äî', data, tension:.25}]}, options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }});
}

// ---------- Exportar / Importar / Dashboard ----------
function toCSVDay(workout){
  const rows = [['date','body_weight_kg','exercise','category','set','weight_kg','reps','rpe','speed_kmh','incline_pct','minutes','feel_1_10']];
  for(const it of workout.items){
    for(const [i,s] of (it.sets||[]).entries()){
      rows.push([
        workout.date, workout.bodyWeight, it.name, it.category, i+1,
        (it.category==='Cardio')? '' : (s.weight??''),
        (it.category==='Cardio')? '' : (s.reps??''),
        s.rpe ?? workout.feel ?? '',
        (it.category==='Cardio')? (s.speed??'') : '',
        (it.category==='Cardio')? (s.grade??'') : '',
        (it.category==='Cardio')? (s.minutes??'') : '',
        workout.feel ?? ''
      ]);
    }
  }
  return rows.map(r=> r.map(v => (''+v).replace(/"/g,'""')).map(v=> /[",\n]/.test(v)? `"${v}"`:v).join(',') ).join('\n');
}
function download(filename, content, mime='text/plain'){
  const a = document.createElement('a'); const blob = new Blob([content], {type:mime});
  a.href = URL.createObjectURL(blob); a.download = filename; a.click(); URL.revokeObjectURL(a.href);
}
function exportDay(){ const w = workDraft ?? currentWorkout(); download(`pt_day_${w.date}.csv`, toCSVDay(w), 'text/csv'); }
function exportMonth(){
  const m = ym(ctxDate);
  const wos = getWorkouts().filter(w=> w.date.startsWith(m));
  const rows = [['date','body_weight_kg','exercise','category','set','weight_kg','reps','rpe','speed_kmh','incline_pct','minutes','feel_1_10']];
  wos.forEach(w=>{
    const csv = toCSVDay(w).split('\n'); csv.shift();
    csv.forEach(line=> { if(line.trim()) rows.push(line.split(',')); });
  });
  download(`pt_month_${m}.csv`, rows.map(r=> r.join(',')).join('\n'), 'text/csv');
}
function exportAll(){
  const wos = getWorkouts().slice().sort((a,b)=> a.date.localeCompare(b.date));
  const rows = [['date','body_weight_kg','exercise','category','set','weight_kg','reps','rpe','speed_kmh','incline_pct','minutes','feel_1_10']];
  wos.forEach(w=>{
    const csv = toCSVDay(w).split('\n'); csv.shift();
    csv.forEach(line=> { if(line.trim()) rows.push(line.split(',')); });
  });
  download(`pt_all.csv`, rows.map(r=> r.join(',')).join('\n'), 'text/csv');
}
function parseCSVLine(line){
  const res=[]; let cur='', inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch=== '"'){ if(inQ && line[i+1]==='"'){ cur+='"'; i++; } else inQ=!inQ; }
    else if(ch===',' && !inQ){ res.push(cur); cur=''; }
    else cur+=ch;
  } res.push(cur); return res;
}
function importDayCSV(text){
  const header = 'date,body_weight_kg,exercise,category,set,weight_kg,reps,rpe,speed_kmh,incline_pct,minutes';
  const lines = text.trim().split(/\r?\n/);
  if(!lines[0].toLowerCase().startsWith('date,')) throw new Error('Cabecera CSV inv√°lida');
  const [date] = lines[1].split(',');
  const w = { ...defaultWorkout(date), items:[] };
  const map = new Map();
  for(let i=1;i<lines.length;i++){
    const cols = parseCSVLine(lines[i]); if(cols.length<11) continue;
    const [dt,bw,ex,cat,idx,wei,reps,rpe,spd,gr,min] = cols;
    w.bodyWeight = Number(bw||w.bodyWeight);
    if(!map.has(ex)) map.set(ex, {exId:'ex_'+ex.toLowerCase().replace(/\s+/g,'_'), name:ex, category:cat, sets:[]});
    const it = map.get(ex);
    if(cat==='Cardio') it.sets.push({speed:Number(spd||0), grade:Number(gr||0), minutes:Number(min||0), rpe:Number(rpe||0)});
    else it.sets.push({weight:Number(wei||0), reps:Number(reps||0), rpe:Number(rpe||0)});
  }
  w.items = Array.from(map.values());
  setCtxDate(ymdToDate(w.date));
  workDraft = JSON.parse(JSON.stringify(w));
  saveCurrentWorkout(workDraft);
  renderDayList(); updateSummary(workDraft); buildMiniCal(); buildHeatmap(); buildGoalsChart(); populateAnaliticaSelect();
  alert('Importado OK');
}
function drawDashboard(workout, kcalTotal){
  const c = el('dashCanvas'); const ctx = c.getContext('2d');
  const w=c.width, h=c.height; ctx.clearRect(0,0,w,h);
  ctx.fillStyle='#0e162e'; ctx.fillRect(0,0,w,h);
  ctx.fillStyle='#e8eefc'; ctx.font='16px -apple-system, Inter, Segoe UI, Roboto, Arial';
  ctx.fillText('PT Dashboard', 12, 22);
  ctx.fillStyle='#9aa5bd'; ctx.fillText(workout.date, 12, 42);
  const inds = workout.indicators || computeIndicators(JSON.parse(JSON.stringify(workout))).indicators;
  const chips=[`Kcal ${kcalTotal}`,`Vol ${inds.volume_total_kg} kg`,`Top ${inds.topSet} kg`,`RPE ${inds.rpeAvg}`,`Cardio ${inds.cardioMin} min`,`Ex ${workout.items.length}`,`Feel ${workout.feel}/10`];
  let x=12,y=72;
  chips.forEach(t=>{
    ctx.fillStyle='#10182a'; ctx.strokeStyle='#1f2a44';
    const pad=8, tw=ctx.measureText(t).width;
    ctx.beginPath(); ctx.roundRect(x, y-16, tw+pad*2, 28, 8); ctx.fill(); ctx.stroke();
    ctx.fillStyle='#e8eefc'; ctx.fillText(t, x+pad, y+4);
    x += tw+pad*2+8; if(x> w-140){ x=12; y+=40; }
  });
  const {progPct}=computeIndicators(JSON.parse(JSON.stringify(workout)));
  const barW=w-24, barH=16, bx=12, by=h-30;
  ctx.fillStyle='#0b1226'; ctx.fillRect(bx,by,barW,barH);
  const pv=Math.max(0,Math.min(1,progPct/100));
  const g=ctx.createLinearGradient(bx,0,bx+barW,0);
  g.addColorStop(0,'#ff6b6b'); g.addColorStop(.5,'#ffd166'); g.addColorStop(1,'#06d6a0');
  ctx.fillStyle=g; ctx.fillRect(bx,by,barW*pv,barH);
  ctx.fillStyle='#9aa5bd'; ctx.fillText(`Cumplimiento: ${progPct}%`, bx, by-8);
}

// ---------- Guardar / Load ----------
function currentWorkout(){
  const wos = getWorkouts();
  const idx = wos.findIndex(w=> w.date===fmt(ctxDate));
  if(idx>=0) return JSON.parse(JSON.stringify(wos[idx]));
  return defaultWorkout(fmt(ctxDate));
}
function saveCurrentWorkout(workout){
  const wos = getWorkouts();
  const idx = wos.findIndex(w=> w.date===workout.date);
  if(idx>=0) wos[idx]=workout; else wos.push(workout);
  setWorkouts(wos); markDirty(false);
}

// ---------- Summary + datos duros ----------
function updateSummary(workout){
  workout.bodyWeight = Number(el('bodyWeight').value||74);
  workout.note = el('note').value||'';
  workout.feel = Number(el('feelRange').value||7);
  const {kcalTotal, progPct} = computeIndicators(workout);
  el('prog').value = progPct; el('progPct').textContent = `${progPct}%`;
  el('kcalTotal').textContent = `${kcalTotal}`;
  updateRawDay(workout);
  drawDashboard(workout, kcalTotal);
}
function updateRawDay(workout){
  const box=el('rawDay'); let out=`Fecha: ${workout.date} | Peso: ${workout.bodyWeight} kg | Feel: ${workout.feel}/10\nNota: ${workout.note||'‚Äî'}\n\n`;
  for(const it of workout.items){
    out += `‚Ä¢ ${it.name} [${it.category}]\n`;
    it.sets.forEach((s,i)=>{
      if(it.category==='Cardio'){ out += `  - #${i+1} ${s.speed||0}km/h @ ${s.grade||0}% √ó ${s.minutes||0}min, RPE ${s.rpe||workout.feel||7}\n`; }
      else{ out += `  - #${i+1} ${s.weight||0}kg √ó ${s.reps||0}, RPE ${s.rpe||workout.feel||7}\n`; }
    });
  } box.textContent = out;
}

// ---------- Feel slider (emoji + color) ----------
function feelUpdateUI(v){
  const em = ['üîí','üò£','üòï','üôÇ','üôÇ','üòå','üòé','üí™','‚ö°Ô∏è','üî•'];
  const idx = Math.min(10, Math.max(1, parseInt(v,10))) - 1;
  el('feelEmoji').textContent = em[idx] || 'üôÇ';
  el('feelLabel').textContent = `${v} / 10`;
  // color del fondo seg√∫n valor
  const wrap = el('feelEmoji').closest('.feel-wrap');
  const colors = ['#1b0b0b','#2a0f0f','#2a1a0f','#1a2610','#102619','#0f2a22','#0f2a28','#0f2a31','#0f233a','#0f1f3a'];
  wrap.style.background = colors[idx] || '#0e162e';
}
el('feelRange').addEventListener('input', ()=> { feelUpdateUI(el('feelRange').value); markDirty(); updateSummary(workDraft); });

// ---------- Refresh general ----------
function refreshAll(){
  const w = workDraft ?? defaultWorkout(fmt(ctxDate));
  el('bodyWeight').value = w.bodyWeight ?? 74;
  el('note').value = w.note ?? '';
  el('feelRange').value = w.feel ?? 7; feelUpdateUI(el('feelRange').value);
  renderDayList();
  updateSummary(w);
  buildMiniCal();
  buildHeatmap();
  buildGoalsChart();
  populateAnaliticaSelect();
  buildExerciseCatalogDatalist();
}

// ---------- Eventos ----------
document.querySelectorAll('nav.tabs button').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('nav.tabs button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.dataset.tab;
    document.querySelectorAll('main section').forEach(s=> s.hidden = (s.id !== 'tab-'+tab));
    if(tab==='calendario'){ buildHeatmap(); }
    if(tab==='metas'){ buildGoalsChart(); }
    if(tab==='graficos'){ populateAnaliticaSelect(); updateExerciseChart(); }
    if(tab==='exportar'){ drawDashboard(workDraft ?? currentWorkout(), computeIndicators(workDraft ?? currentWorkout()).kcalTotal); }
  });
});
el('btnToday').addEventListener('click', ()=> setCtxDate(today()));
el('btnNewToday').addEventListener('click', ()=>{
  setCtxDate(today());
  workDraft = defaultWorkout(fmt(ctxDate));
  workDraft.items = JSON.parse(JSON.stringify(getBase()));
  renderDayList(); updateSummary(workDraft); markDirty(true);
});
el('btnLoadBase').addEventListener('click', ()=>{
  if(!workDraft) workDraft = defaultWorkout(fmt(ctxDate));
  workDraft.items = workDraft.items.concat(JSON.parse(JSON.stringify(getBase())));
  renderDayList(); updateSummary(workDraft); markDirty();
});
el('btnSave').addEventListener('click', ()=>{
  if(!workDraft) workDraft = defaultWorkout(fmt(ctxDate));
  workDraft.bodyWeight = Number(el('bodyWeight').value||74);
  workDraft.note = el('note').value||'';
  workDraft.feel = Number(el('feelRange').value||7);
  computeIndicators(workDraft);
  saveCurrentWorkout(workDraft);
  buildMiniCal(); buildHeatmap(); buildGoalsChart(); populateAnaliticaSelect();
  alert('Sesi√≥n guardada');
});
el('btnSetGoal').addEventListener('click', ()=>{
  const m = ym(ctxDate);
  const g = getGoals();
  const cur = getMonthGoal(m);
  const nd = Number(prompt(`Meta de asistencia para ${m} (d√≠as):`, cur.days)||cur.days);
  const nv = Number(prompt(`Meta de volumen (kg):`, cur.volume)||cur.volume);
  const nc = Number(prompt(`Meta de cardio (%):`, Math.round(cur.cardioRateTarget*100))||Math.round(cur.cardioRateTarget*100))/100;
  const nt = prompt('Texto del objetivo:', cur.goalText||AUG_TEXT) || cur.goalText;
  g[m] = {...cur, days:nd, volume:nv, cardioRateTarget:nc, goalText:nt};
  setGoals(g); buildGoalsChart(); alert('Meta actualizada');
});
el('monPrev').addEventListener('click', ()=>{ const d=new Date(ctxDate); d.setMonth(d.getMonth()-1); setCtxDate(d); });
el('monNext').addEventListener('click', ()=>{ const d=new Date(ctxDate); d.setMonth(d.getMonth()+1); setCtxDate(d); });

el('csvDay').addEventListener('click', exportDay);
el('csvMonth').addEventListener('click', exportMonth);
el('csvAll').addEventListener('click', exportAll);
el('btnImport').addEventListener('click', ()=>{
  const f = el('csvImport').files?.[0];
  if(!f){ alert('Selecciona un archivo CSV'); return; }
  const rd = new FileReader();
  rd.onload = ()=> { try{ importDayCSV(String(rd.result)); } catch(e){ alert('Error al importar: '+e.message); } };
  rd.readAsText(f);
});
el('btnPNG').addEventListener('click', ()=>{
  const url = el('dashCanvas').toDataURL('image/png');
  const a = document.createElement('a'); a.href=url; a.download=`dashboard_${fmt(ctxDate)}.png`; a.click();
});
el('btnPDF').addEventListener('click', ()=> window.print());

el('bodyWeight').addEventListener('input', ()=>{
  if(!workDraft) workDraft = defaultWorkout(fmt(ctxDate));
  workDraft.bodyWeight = Number(el('bodyWeight').value||74);
  markDirty(); updateSummary(workDraft);
});
el('note').addEventListener('input', ()=>{
  if(!workDraft) workDraft = defaultWorkout(fmt(ctxDate));
  workDraft.note = el('note').value||'';
  markDirty(); updateSummary(workDraft);
});

// ---------- Inicializaci√≥n ----------
initSimpleAdd();
setCtxDate(today());

// ---------- Auto-tests b√°sicos ----------
console.log('%cAuto-tests', 'color:#9ae6b4');
console.assert(Math.round(epley1RM(100,10))===133, 'Epley 100x10 ‚âà 133');
console.assert(Math.round(kcalStrengthSet(7,74))>0, 'kcal fuerza ok');
console.assert(Math.round(kcalCardioSet(6,7,10,74))>0, 'kcal cardio ok');

</script>
</body>
</html>


